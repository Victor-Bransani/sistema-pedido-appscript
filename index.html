<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Pedidos - Senac</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* =================================================================
   DESIGN SYSTEM MINIMALISTA - PERFORMANCE FIRST
   ================================================================= */

:root {
  /* ===== CORES SIMPLES E MODERNAS ===== */
  --color-background: #fafafa;
  --color-surface: #ffffff;
  --color-border: #e5e7eb;
  --color-border-light: #f3f4f6;
  
  /* Texto */
  --text-primary: #111827;
  --text-secondary: #6b7280;
  --text-tertiary: #9ca3af;
  --text-inverse: #ffffff;
  
  /* Cores de ação */
  --color-primary: #3b82f6;
  --color-primary-hover: #2563eb;
  --color-primary-light: #dbeafe;
  
  /* Status */
  --color-success: #10b981;
  --color-success-light: #d1fae5;
  --color-warning: #f59e0b;
  --color-warning-light: #fef3c7;
  --color-danger: #ef4444;
  --color-danger-light: #fee2e2;
  
  /* Sombras sutis */
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  
  /* Espaçamento 8pt grid */
  --space-1: 0.25rem;
  --space-2: 0.5rem;
  --space-3: 0.75rem;
  --space-4: 1rem;
  --space-5: 1.25rem;
  --space-6: 1.5rem;
  --space-8: 2rem;
  --space-12: 3rem;
  
  /* Bordas */
  --radius-sm: 0.375rem;
  --radius-md: 0.5rem;
  --radius-lg: 0.75rem;
  --radius-xl: 1rem;
  --radius-full: 9999px;
  
  /* Transições rápidas */
  --transition: 150ms ease-out;
}

/* =================================================================
   RESET MÍNIMO
   ================================================================= */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  line-height: 1.5;
  -webkit-text-size-adjust: 100%;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background-color: var(--color-background);
  color: var(--text-primary);
  font-size: 14px;
  line-height: 1.5;
}

/* =================================================================
   TIPOGRAFIA SIMPLES
   ================================================================= */
h1, h2, h3, h4, h5, h6 {
  font-weight: 600;
  line-height: 1.25;
  color: var(--text-primary);
  margin: 0;
}

h1 { font-size: 1.875rem; }
h2 { font-size: 1.5rem; }
h3 { font-size: 1.25rem; }
h4 { font-size: 1.125rem; }

p {
  margin: 0;
  color: var(--text-secondary);
}

/* =================================================================
   BOTÕES LIMPOS
   ================================================================= */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-2);
  padding: var(--space-3) var(--space-4);
  border: 1px solid transparent;
  border-radius: var(--radius-md);
  font-size: 0.875rem;
  font-weight: 500;
  line-height: 1;
  cursor: pointer;
  transition: all var(--transition);
  text-decoration: none;
  white-space: nowrap;
  min-height: 40px;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background-color: var(--color-primary);
  color: var(--text-inverse);
}

.btn-primary:hover:not(:disabled) {
  background-color: var(--color-primary-hover);
}

.btn-secondary {
  background-color: var(--color-surface);
  color: var(--text-primary);
  border-color: var(--color-border);
}

.btn-secondary:hover:not(:disabled) {
  background-color: var(--color-border-light);
}

.btn-success {
  background-color: var(--color-success);
  color: var(--text-inverse);
}

.btn-warning {
  background-color: var(--color-warning);
  color: var(--text-inverse);
}

.btn-danger {
  background-color: var(--color-danger);
  color: var(--text-inverse);
}

.btn-sm {
  padding: var(--space-2) var(--space-3);
  font-size: 0.75rem;
  min-height: 32px;
}

.btn-lg {
  padding: var(--space-4) var(--space-6);
  font-size: 1rem;
  min-height: 48px;
}

/* =================================================================
   FORMULÁRIOS SIMPLES
   ================================================================= */
.form-group {
  margin-bottom: var(--space-4);
}

.form-label {
  display: block;
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: var(--space-2);
}

.form-input,
.form-select,
.form-textarea {
  width: 100%;
  padding: var(--space-3);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  font-size: 0.875rem;
  background-color: var(--color-surface);
  color: var(--text-primary);
  transition: border-color var(--transition);
  min-height: 40px;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  outline: none;
  border-color: var(--color-primary);
}

.form-textarea {
  min-height: 80px;
  resize: vertical;
}

.form-select {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 0.75rem center;
  background-repeat: no-repeat;
  background-size: 1rem;
  padding-right: 2.5rem;
}

/* =================================================================
   CARDS MINIMALISTAS
   ================================================================= */
.card {
  background-color: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  transition: box-shadow var(--transition);
}

.card:hover {
  box-shadow: var(--shadow-md);
}

.card-header {
  padding: var(--space-6);
  border-bottom: 1px solid var(--color-border-light);
}

.card-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--text-primary);
}

.card-body {
  padding: var(--space-6);
}

.card-footer {
  padding: var(--space-6);
  border-top: 1px solid var(--color-border-light);
  background-color: var(--color-border-light);
}

/* =================================================================
   BADGES SIMPLES
   ================================================================= */
.badge {
  display: inline-flex;
  align-items: center;
  padding: var(--space-1) var(--space-3);
  border-radius: var(--radius-full);
  font-size: 0.75rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.025em;
}

.badge-primary {
  background-color: var(--color-primary-light);
  color: var(--color-primary);
}

.badge-success {
  background-color: var(--color-success-light);
  color: var(--color-success);
}

.badge-warning {
  background-color: var(--color-warning-light);
  color: var(--color-warning);
}

.badge-danger {
  background-color: var(--color-danger-light);
  color: var(--color-danger);
}

/* =================================================================
   MODAIS LIMPOS
   ================================================================= */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: var(--space-4);
  opacity: 0;
  visibility: hidden;
  transition: all var(--transition);
}

.modal.show {
  opacity: 1;
  visibility: visible;
}

.modal-content {
  background-color: var(--color-surface);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
  max-width: 90vw;
  max-height: 90vh;
  width: 100%;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.modal-content-sm { max-width: 400px; }
.modal-content-md { max-width: 600px; }
.modal-content-lg { max-width: 800px; }
.modal-content-xl { max-width: 1000px; }

.modal-header {
  padding: var(--space-6);
  border-bottom: 1px solid var(--color-border-light);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text-primary);
}

.modal-close {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border: none;
  background: none;
  color: var(--text-tertiary);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--transition);
}

.modal-close:hover {
  background-color: var(--color-border-light);
  color: var(--text-secondary);
}

.modal-body {
  padding: var(--space-6);
  flex: 1;
  overflow-y: auto;
}

.modal-footer {
  padding: var(--space-6);
  border-top: 1px solid var(--color-border-light);
  display: flex;
  gap: var(--space-3);
  justify-content: flex-end;
  background-color: var(--color-border-light);
}

/* =================================================================
   NOTIFICAÇÕES SIMPLES
   ================================================================= */
.notification-container {
  position: fixed;
  top: var(--space-4);
  right: var(--space-4);
  z-index: 1100;
  max-width: 400px;
}

.notification {
  background-color: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  padding: var(--space-4);
  margin-bottom: var(--space-3);
  border-left: 4px solid var(--color-primary);
  animation: slideIn var(--transition) ease-out;
}

.notification-success { border-left-color: var(--color-success); }
.notification-warning { border-left-color: var(--color-warning); }
.notification-error { border-left-color: var(--color-danger); }

.notification-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--space-2);
}

.notification-title {
  font-weight: 600;
  font-size: 0.875rem;
  color: var(--text-primary);
}

.notification-message {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.notification-close {
  background: none;
  border: none;
  color: var(--text-tertiary);
  cursor: pointer;
  padding: var(--space-1);
  border-radius: var(--radius-sm);
  transition: all var(--transition);
}

.notification-close:hover {
  background-color: var(--color-border-light);
  color: var(--text-secondary);
}

/* =================================================================
   LOADER SIMPLES
   ================================================================= */
.loader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(255, 255, 255, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  flex-direction: column;
  gap: var(--space-4);
  opacity: 0;
  visibility: hidden;
  transition: all var(--transition);
}

.loader:not(.hidden) {
  opacity: 1;
  visibility: visible;
}

.spinner {
  width: 32px;
  height: 32px;
  border: 3px solid var(--color-border);
  border-top: 3px solid var(--color-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.loader-text {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
}

/* =================================================================
   LAYOUT PRINCIPAL
   ================================================================= */
.app-wrapper {
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* =================================================================
   SIDEBAR LIMPA
   ================================================================= */
.sidebar {
  width: 260px;
  background-color: var(--color-surface);
  border-right: 1px solid var(--color-border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow-y: auto;
}

.sidebar-header {
  padding: var(--space-6);
  border-bottom: 1px solid var(--color-border-light);
  text-align: center;
}

.logo {
  max-width: 100px;
  height: auto;
}

.sidebar-nav {
  flex: 1;
  padding: var(--space-4) 0;
}

.nav-section {
  margin-bottom: var(--space-6);
}

.nav-section-title {
  padding: 0 var(--space-4) var(--space-2);
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-tertiary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.nav-menu {
  list-style: none;
  margin: 0;
  padding: 0;
}

.nav-item {
  margin-bottom: var(--space-1);
  padding: 0 var(--space-3);
}

.nav-link {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-3) var(--space-4);
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
  text-decoration: none;
  border-radius: var(--radius-md);
  transition: all var(--transition);
  cursor: pointer;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
}

.nav-link:hover {
  background-color: var(--color-border-light);
  color: var(--text-primary);
}

.nav-link.active {
  background-color: var(--color-primary-light);
  color: var(--color-primary);
  font-weight: 600;
}

.nav-link-icon {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
}

.nav-link-badge {
  margin-left: auto;
  background-color: var(--color-danger);
  color: var(--text-inverse);
  font-size: 0.75rem;
  padding: 2px 6px;
  border-radius: var(--radius-full);
  min-width: 18px;
  text-align: center;
  line-height: 1;
}

.sidebar-footer {
  padding: var(--space-4);
  border-top: 1px solid var(--color-border-light);
}

/* =================================================================
   HEADER LIMPO
   ================================================================= */
.header {
  background-color: var(--color-surface);
  border-bottom: 1px solid var(--color-border);
  padding: var(--space-4) var(--space-6);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
  min-height: 64px;
}

.header-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: var(--space-4);
}

.notification-bell {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: none;
  border: none;
  color: var(--text-secondary);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--transition);
}

.notification-bell:hover {
  background-color: var(--color-border-light);
  color: var(--text-primary);
}

.notification-badge {
  position: absolute;
  top: 6px;
  right: 6px;
  background-color: var(--color-danger);
  color: var(--text-inverse);
  font-size: 0.75rem;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: var(--radius-full);
  min-width: 16px;
  text-align: center;
  line-height: 1;
}

.user-profile {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-2) var(--space-3);
  border-radius: var(--radius-lg);
  background-color: var(--color-border-light);
  transition: all var(--transition);
  cursor: pointer;
}

.user-profile:hover {
  background-color: var(--color-border);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: var(--radius-full);
  background-color: var(--color-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-inverse);
  font-weight: 600;
  font-size: 0.875rem;
}

.user-info {
  display: flex;
  flex-direction: column;
  min-width: 0;
}

.user-name {
  font-weight: 500;
  font-size: 0.875rem;
  color: var(--text-primary);
  line-height: 1.2;
}

.user-role {
  font-size: 0.75rem;
  color: var(--text-secondary);
  line-height: 1.2;
}

/* =================================================================
   MAIN CONTENT
   ================================================================= */
.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.main-area {
  flex: 1;
  overflow-y: auto;
  padding: var(--space-6);
}

/* =================================================================
   SEÇÕES
   ================================================================= */
.section {
  opacity: 0;
  transform: translateY(10px);
  transition: all var(--transition);
}

.section:not(.hidden) {
  opacity: 1;
  transform: translateY(0);
}

.page-header {
  margin-bottom: var(--space-8);
}

.page-title {
  font-size: 1.875rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: var(--space-2);
}

.page-subtitle {
  font-size: 1rem;
  color: var(--text-secondary);
  margin: 0;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--space-6);
}

.section-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

.section-actions {
  display: flex;
  gap: var(--space-3);
}

/* =================================================================
   DASHBOARD STATS
   ================================================================= */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: var(--space-6);
  margin-bottom: var(--space-8);
}

.stat-card {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--space-6);
  transition: all var(--transition);
}

.stat-card:hover {
  box-shadow: var(--shadow-md);
}

.stat-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--space-4);
}

.stat-title {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
  margin: 0;
}

.stat-icon {
  width: 20px;
  height: 20px;
  color: var(--color-primary);
}

.stat-value {
  font-size: 1.875rem;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1;
}

/* =================================================================
   ORDERS GRID
   ================================================================= */
.orders-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: var(--space-6);
}

.order-card {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  transition: all var(--transition);
}

.order-card:hover {
  box-shadow: var(--shadow-md);
}

.order-header {
  padding: var(--space-4) var(--space-6);
  border-bottom: 1px solid var(--color-border-light);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.order-number {
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

.order-body {
  padding: var(--space-6);
}

.order-info {
  display: grid;
  gap: var(--space-3);
  margin-bottom: var(--space-6);
}

.order-info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.875rem;
}

.order-info-label {
  color: var(--text-secondary);
  font-weight: 500;
}

.order-info-value {
  color: var(--text-primary);
  font-weight: 500;
}

.order-footer {
  padding: var(--space-4) var(--space-6);
  border-top: 1px solid var(--color-border-light);
  background-color: var(--color-border-light);
  display: flex;
  gap: var(--space-2);
  flex-wrap: wrap;
}

/* =================================================================
   TABELAS
   ================================================================= */
.table-container {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table th,
.table td {
  padding: var(--space-4);
  text-align: left;
  border-bottom: 1px solid var(--color-border-light);
  font-size: 0.875rem;
}

.table th {
  background-color: var(--color-border-light);
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.025em;
  font-size: 0.75rem;
}

.table tbody tr:hover {
  background-color: var(--color-border-light);
}

.table tbody tr:last-child td {
  border-bottom: none;
}

/* =================================================================
   SEARCH E FILTROS
   ================================================================= */
.search-filters {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--space-6);
  margin-bottom: var(--space-6);
}

.search-row {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: var(--space-4);
  align-items: end;
}

.filters-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--space-4);
  margin-top: var(--space-6);
  padding-top: var(--space-6);
  border-top: 1px solid var(--color-border-light);
}

.search-input {
  position: relative;
}

.search-input input {
  padding-left: 2.5rem;
}

.search-icon {
  position: absolute;
  left: var(--space-3);
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-tertiary);
  width: 16px;
  height: 16px;
}

/* =================================================================
   UPLOAD AREA
   ================================================================= */
.upload-area {
  background: var(--color-surface);
  border: 2px dashed var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--space-12) var(--space-6);
  text-align: center;
  transition: all var(--transition);
  cursor: pointer;
}

.upload-area:hover {
  border-color: var(--color-primary);
  background-color: var(--color-primary-light);
}

.upload-area.dragover {
  border-color: var(--color-primary);
  background-color: var(--color-primary-light);
}

.upload-icon {
  width: 48px;
  height: 48px;
  color: var(--text-tertiary);
  margin: 0 auto var(--space-4);
}

.upload-text {
  font-size: 1rem;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: var(--space-2);
}

.upload-subtext {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.selected-file {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-3);
  background-color: var(--color-success-light);
  border: 1px solid var(--color-success);
  border-radius: var(--radius-md);
  margin-top: var(--space-4);
}

.file-icon {
  width: 20px;
  height: 20px;
  color: var(--color-success);
}

.file-info {
  flex: 1;
}

.file-name {
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: var(--space-1);
}

.file-size {
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.remove-file {
  background: none;
  border: none;
  color: var(--text-tertiary);
  cursor: pointer;
  padding: var(--space-1);
  border-radius: var(--radius-sm);
  transition: all var(--transition);
}

.remove-file:hover {
  background-color: var(--color-danger-light);
  color: var(--color-danger);
}

/* =================================================================
   PAGINAÇÃO
   ================================================================= */
.pagination-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-3);
  padding: var(--space-4);
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  margin-top: var(--space-6);
}

/* =================================================================
   ANIMAÇÕES MÍNIMAS
   ================================================================= */
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* =================================================================
   RESPONSIVIDADE SIMPLES
   ================================================================= */
@media (max-width: 1024px) {
  .sidebar {
    width: 220px;
  }
  
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
  }
  
  .orders-grid {
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-4);
  }
  
  .main-area {
    padding: var(--space-4);
  }
}

@media (max-width: 768px) {
  .sidebar {
    position: fixed;
    left: -260px;
    z-index: 1000;
    transition: left var(--transition);
    height: 100vh;
    top: 0;
  }
  
  .sidebar.open {
    left: 0;
  }
  
  .main-content {
    margin-left: 0;
  }
  
  .header {
    padding: var(--space-3) var(--space-4);
    min-height: 56px;
  }
  
  .header-title {
    font-size: 1.25rem;
  }
  
  .main-area {
    padding: var(--space-3);
  }
  
  .page-title {
    font-size: 1.5rem;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
    gap: var(--space-3);
  }
  
  .orders-grid {
    grid-template-columns: 1fr;
    gap: var(--space-3);
  }
  
  .search-row {
    grid-template-columns: 1fr;
    gap: var(--space-3);
  }
  
  .filters-row {
    grid-template-columns: 1fr;
    gap: var(--space-3);
  }
  
  .modal-content {
    margin: var(--space-3);
    max-width: calc(100vw - 1.5rem);
    max-height: calc(100vh - 1.5rem);
  }
  
  .modal-footer {
    flex-direction: column;
    gap: var(--space-2);
  }
  
  .section-header {
    flex-direction: column;
    align-items: stretch;
    gap: var(--space-3);
  }
  
  .user-info {
    display: none;
  }
  
  .notification-container {
    left: var(--space-3);
    right: var(--space-3);
    max-width: none;
  }
  
  .order-footer {
    flex-direction: column;
    gap: var(--space-2);
  }
  
  .btn {
    width: 100%;
    justify-content: center;
  }
  
  .btn-sm {
    width: auto;
  }
}

@media (max-width: 480px) {
  .header-actions {
    gap: var(--space-2);
  }
  
  .user-profile {
    padding: var(--space-2);
  }
  
  .upload-area {
    padding: var(--space-8) var(--space-4);
  }
  
  .pagination-controls {
    flex-direction: column;
    gap: var(--space-2);
  }
}

/* =================================================================
   MODO ESCURO SIMPLES
   ================================================================= */
@media (prefers-color-scheme: dark) {
  :root {
    --color-background: #111827;
    --color-surface: #1f2937;
    --color-border: #374151;
    --color-border-light: #4b5563;
    
    --text-primary: #f9fafb;
    --text-secondary: #d1d5db;
    --text-tertiary: #9ca3af;
    --text-inverse: #111827;
    
    --color-primary-light: #1e3a8a;
    --color-success-light: #064e3b;
    --color-warning-light: #78350f;
    --color-danger-light: #7f1d1d;
  }
  
  .form-input,
  .form-select,
  .form-textarea {
    background-color: var(--color-surface);
    color: var(--text-primary);
  }
  
  .btn-secondary {
    background-color: var(--color-surface);
    color: var(--text-primary);
  }
  
  .btn-secondary:hover:not(:disabled) {
    background-color: var(--color-border);
  }
}

/* =================================================================
   UTILIDADES ESSENCIAIS
   ================================================================= */
.hidden { display: none !important; }
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

.text-center { text-align: center; }
.text-right { text-align: right; }
.font-medium { font-weight: 500; }
.font-semibold { font-weight: 600; }
.font-bold { font-weight: 700; }
.text-sm { font-size: 0.875rem; }
.text-xs { font-size: 0.75rem; }
.text-lg { font-size: 1.125rem; }
.text-xl { font-size: 1.25rem; }

.mb-0 { margin-bottom: 0; }
.mb-2 { margin-bottom: var(--space-2); }
.mb-4 { margin-bottom: var(--space-4); }
.mb-6 { margin-bottom: var(--space-6); }
.mt-2 { margin-top: var(--space-2); }
.mt-4 { margin-top: var(--space-4); }
.mt-6 { margin-top: var(--space-6); }

.w-full { width: 100%; }
.h-full { height: 100%; }
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.justify-center { justify-content: center; }
.gap-2 { gap: var(--space-2); }
.gap-4 { gap: var(--space-4); }
.gap-6 { gap: var(--space-6); }

.grid { display: grid; }
.grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
.grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
.grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }

/* =================================================================
   ÍCONES DE BOTÃO
   ================================================================= */
.btn-icon-sm {
  width: 16px;
  height: 16px;
}

.btn-icon {
  width: 20px;
  height: 20px;
}

/* =================================================================
   ESTADOS DE FOCO ACESSÍVEIS
   ================================================================= */
button:focus-visible,
a:focus-visible,
[tabindex]:focus-visible {
  outline: 2px solid var(--color-primary);
  outline-offset: 2px;
}

/* =================================================================
   PRINT STYLES
   ================================================================= */
@media print {
  .sidebar,
  .header-actions,
  .modal,
  .notification-container,
  .loader,
  .btn {
    display: none !important;
  }
  
  .main-content {
    margin: 0 !important;
  }
  
  .card {
    break-inside: avoid;
    box-shadow: none;
    border: 1px solid #000;
  }
}

/* =================================================================
   PERFORMANCE OPTIMIZATIONS
   ================================================================= */
* {
  /* Remove transições desnecessárias em elementos que não precisam */
}

.card,
.btn,
.nav-link,
.form-input,
.form-select,
.form-textarea {
  /* Apenas elementos interativos têm transições */
  will-change: auto;
}

/* Reduzir animações para usuários que preferem menos movimento */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
</style>


</head>
<body>
    <!-- Loader -->
    <div id="loader" class="loader hidden">
        <div class="flex flex-col items-center">
            <div class="spinner"></div>
            <div class="loader-text">Carregando...</div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal hidden">
        <div class="modal-content modal-content-sm">
            <div class="modal-header">
                <h2 class="modal-title">Acesso ao Sistema</h2>
            </div>
            <div class="modal-body">
                <div id="login-form">
                    <div class="form-group">
                        <label class="form-label" for="login-email">E-mail</label>
                        <input type="email" id="login-email" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="login-password">Senha</label>
                        <input type="password" id="login-password" class="form-input" required>
                    </div>
                    <button id="login-submit-btn" class="btn btn-primary w-full">Entrar</button>
                </div>
                <div class="text-center mt-4">
                    <p class="text-sm text-secondary">
                        Não tem acesso? Contate o administrador do sistema.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Register User Modal (Admin only) -->
    <div id="register-modal" class="modal hidden">
        <div class="modal-content modal-content-md">
            <button class="modal-close" id="close-register-btn">
                <i data-feather="x"></i>
            </button>
            <div class="modal-header">
                <h2 class="modal-title">Cadastrar Novo Usuário</h2>
            </div>
            <div class="modal-body">
                <form id="register-form">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label" for="register-name">Nome Completo</label>
                            <input type="text" id="register-name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="register-email">E-mail</label>
                            <input type="email" id="register-email" class="form-input" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label" for="register-password">Senha Temporária</label>
                            <input type="password" id="register-password" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="register-role">Função</label>
                            <select id="register-role" class="form-select" required>
                                <option value="comprador">Comprador</option>
                                <option value="recebedor">Recebedor</option>
                                <option value="retirador">Retirador</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-register-btn">Cancelar</button>
                <button type="submit" form="register-form" class="btn btn-primary">Cadastrar Usuário</button>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="modal hidden">
        <div class="modal-content modal-content-lg">
            <button class="modal-close" id="close-details-btn">
                <i data-feather="x"></i>
            </button>
            <div class="modal-header">
                <h2 class="modal-title" id="details-modal-title">Detalhes do Pedido</h2>
            </div>
            <div class="modal-body" id="details-modal-body">
                <!-- Content will be dynamically loaded -->
            </div>
            <div class="modal-footer" id="details-modal-footer">
                <!-- Actions will be dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div id="status-modal" class="modal hidden">
        <div class="modal-content modal-content-md">
            <button class="modal-close" id="close-status-btn">
                <i data-feather="x"></i>
            </button>
            <div class="modal-header">
                <h2 class="modal-title" id="status-modal-title">Atualizar Status</h2>
            </div>
            <div class="modal-body">
                <form id="status-form">
                    <input type="hidden" id="status-pedido-id">
                    <div class="form-group">
                        <label class="form-label" for="status-select">Novo Status</label>
                        <select id="status-select" class="form-select" required>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="status-observacoes">Observações</label>
                        <textarea id="status-observacoes" class="form-textarea" rows="3" placeholder="Adicione observações sobre esta atualização..."></textarea>
                    </div>
                    <div id="additional-fields">
                        <!-- Additional fields will be added dynamically based on status -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-status-btn">Cancelar</button>
                <button type="submit" form="status-form" class="btn btn-primary">Atualizar Status</button>
            </div>
        </div>
    </div>

    <!-- Users Management Modal (Admin only) -->
    <div id="users-modal" class="modal hidden">
        <div class="modal-content modal-content-xl">
            <button class="modal-close" id="close-users-btn">
                <i data-feather="x"></i>
            </button>
            <div class="modal-header">
                <h2 class="modal-title">Gerenciamento de Usuários</h2>
                <button class="btn btn-primary btn-sm" id="open-register-modal-from-admin">
                    <i data-feather="plus" class="nav-link-icon"></i>
                    Novo Usuário
                </button>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Função</th>
                                <th>Status</th>
                                <th>Último Login</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Wrapper -->
    <div class="app-wrapper hidden" id="app-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="https://logodownload.org/wp-content/uploads/2017/05/senac-logo-4.png" alt="Logo Senac" class="logo">
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <button id="dashboard-btn" class="nav-link">
                                <i data-feather="grid" class="nav-link-icon"></i>
                                <span>Dashboard</span>
                            </button>
                        </li>
                        <li class="nav-item" id="nav-buyer" style="display: none;">
                            <button id="buyer-btn" class="nav-link">
                                <i data-feather="shopping-cart" class="nav-link-icon"></i>
                                <span>Comprador</span>
                            </button>
                        </li>
                        <li class="nav-item" id="nav-receiver" style="display: none;">
                            <button id="receiver-btn" class="nav-link">
                                <i data-feather="box" class="nav-link-icon"></i>
                                <span>Recebimento</span>
                            </button>
                        </li>
                        <li class="nav-item" id="nav-retirador" style="display: none;">
                            <button id="retirador-btn" class="nav-link">
                                <i data-feather="truck" class="nav-link-icon"></i>
                                <span>Retirada</span>
                            </button>
                        </li>
                        <li class="nav-item" id="nav-admin" style="display: none;">
                            <button id="admin-btn" class="nav-link">
                                <i data-feather="settings" class="nav-link-icon"></i>
                                <span>Administração</span>
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="nav-section">
                    <h3 class="nav-section-title">Relatórios</h3>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <button id="report-status-btn" class="nav-link">
                                <i data-feather="pie-chart" class="nav-link-icon"></i>
                                <span>Pedidos por Status</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button id="report-supplier-btn" class="nav-link">
                                <i data-feather="bar-chart-2" class="nav-link-icon"></i>
                                <span>Fornecedores</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <button id="report-performance-btn" class="nav-link">
                                <i data-feather="activity" class="nav-link-icon"></i>
                                <span>Performance</span>
                            </button>
                        </li>
                    </ul>
                </div>
            </nav>
            <div class="sidebar-footer">
                <button id="logout-btn" class="btn btn-secondary w-full">
                    <i data-feather="log-out" class="nav-link-icon"></i>
                    <span>Sair</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <header class="header">
                <h1 class="header-title" id="page-title">Dashboard</h1>
                <div class="header-actions">
                    <button class="notification-bell" id="notification-bell">
                        <i data-feather="bell"></i>
                        <span class="notification-badge hidden" id="notification-count">0</span>
                    </button>
                    <div class="user-profile">
                        <div class="user-avatar" id="user-avatar"></div>
                        <div class="user-info">
                            <span class="user-name" id="user-name"></span>
                            <span class="user-role" id="user-role"></span>
                        </div>
                    </div>
                </div>
            </header>

            <main class="main-area">
                <!-- Dashboard Section -->
                <section id="dashboard-section" class="section hidden">
                    <div class="page-header">
                        <h2 class="page-title">Visão Geral</h2>
                        <p class="page-subtitle">Acompanhe as principais métricas do sistema.</p>
                    </div>
                    
                    <div class="stats-grid" id="dashboard-stats">
                        <!-- Stats cards will be loaded here -->
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Pedidos por Status</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Pedidos Recentes</h3>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Nº Pedido</th>
                                                <th>Fornecedor</th>
                                                <th>Status</th>
                                                <th>Valor</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recent-orders-table-body">
                                            <!-- Recent orders will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Buyer Section -->
                <section id="buyer-section" class="section hidden">
                    <div class="page-header">
                        <h2 class="page-title">Painel do Comprador</h2>
                        <p class="page-subtitle">Gerencie seus pedidos de compra e acompanhe o status.</p>
                    </div>

                    <div class="card mb-6">
                        <div class="card-header">
                            <h3 class="card-title">Upload de Pedido de Compra (PDF)</h3>
                        </div>
                        <div class="card-body">
                            <div class="upload-area" id="upload-area">
                                <input type="file" id="pdf-upload" accept="application/pdf" class="hidden">
                                <i data-feather="upload-cloud" class="upload-icon"></i>
                                <p class="upload-text">Arraste e solte seu PDF aqui ou clique para selecionar</p>
                                <p class="upload-subtext">Apenas arquivos PDF são aceitos.</p>
                            </div>
                            <div id="selected-file-display" class="selected-file hidden">
                                <i data-feather="file-text" class="file-icon"></i>
                                <div class="file-info">
                                    <span class="file-name" id="selected-file-name"></span>
                                    <span class="file-size" id="selected-file-size"></span>
                                </div>
                                <button class="remove-file" id="remove-file-btn"><i data-feather="x"></i></button>
                            </div>
                            <div class="text-right mt-4">
                                <button id="process-pdf" class="btn btn-primary" disabled>
                                    <i data-feather="send" class="nav-link-icon"></i>
                                    Processar e Enviar Pedido
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="section-header">
                        <h3 class="section-title">Meus Pedidos Enviados</h3>
                    </div>

                    <div class="search-filters">
                        <div class="search-row">
                            <div class="form-group mb-0">
                                <label class="form-label sr-only" for="buyer-search">Buscar Pedidos</label>
                                <div class="relative">
                                    <input type="text" id="buyer-search" class="form-input" placeholder="Buscar por Nº Pedido, Fornecedor, CNPJ ou item...">
                                    <i data-feather="search" class="search-icon"></i>
                                </div>
                            </div>
                            <button class="btn btn-secondary" id="buyer-filter-btn">
                                <i data-feather="filter" class="nav-link-icon"></i>
                                Filtrar
                            </button>
                        </div>
                        <div class="filters-row hidden" id="buyer-filters-area">
                            <div class="form-group mb-0">
                                <label class="form-label" for="buyer-status-filter">Status</label>
                                <select id="buyer-status-filter" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Em Trânsito">Em Trânsito</option>
                                    <option value="Recebido">Recebido</option>
                                    <option value="Aguardando Retirada">Aguardando Retirada</option>
                                    <option value="Retirado">Retirado</option>
                                    <option value="Finalizado">Finalizado</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                            <div class="form-group mb-0">
                                <label class="form-label" for="buyer-priority-filter">Prioridade</label>
                                <select id="buyer-priority-filter" class="form-select">
                                    <option value="">Todas</option>
                                    <option value="Normal">Normal</option>
                                    <option value="Alta">Alta</option>
                                    <option value="Urgente">Urgente</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="buyer-orders-container" class="orders-grid">
                        <!-- Orders will be loaded here -->
                    </div>
                    <div id="buyer-pagination" class="pagination-controls text-center mt-4"></div>
                </section>

                <!-- Receiver Section -->
                <section id="receiver-section" class="section hidden">
                    <div class="page-header">
                        <h2 class="page-title">Painel de Recebimento</h2>
                        <p class="page-subtitle">Gerencie os pedidos que precisam ser recebidos e inspecionados.</p>
                    </div>

                    <div class="search-filters">
                        <div class="search-row">
                            <div class="form-group mb-0">
                                <label class="form-label sr-only" for="receiver-search">Buscar Pedidos</label>
                                <div class="relative">
                                    <input type="text" id="receiver-search" class="form-input" placeholder="Buscar por Nº Pedido, Fornecedor, CNPJ ou item...">
                                    <i data-feather="search" class="search-icon"></i>
                                </div>
                            </div>
                            <button class="btn btn-secondary" id="receiver-filter-btn">
                                <i data-feather="filter" class="nav-link-icon"></i>
                                Filtrar
                            </button>
                        </div>
                        <div class="filters-row hidden" id="receiver-filters-area">
                            <div class="form-group mb-0">
                                <label class="form-label" for="receiver-status-filter">Status</label>
                                <select id="receiver-status-filter" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Em Trânsito">Em Trânsito</option>
                                    <option value="Recebido">Recebido</option>
                                </select>
                            </div>
                            <div class="form-group mb-0">
                                <label class="form-label" for="receiver-priority-filter">Prioridade</label>
                                <select id="receiver-priority-filter" class="form-select">
                                    <option value="">Todas</option>
                                    <option value="Normal">Normal</option>
                                    <option value="Alta">Alta</option>
                                    <option value="Urgente">Urgente</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="receiver-orders-container" class="orders-grid">
                        <!-- Orders will be loaded here -->
                    </div>
                    <div id="receiver-pagination" class="pagination-controls text-center mt-4"></div>
                </section>

                <!-- Retirador Section -->
                <section id="retirador-section" class="section hidden">
                    <div class="page-header">
                        <h2 class="page-title">Painel de Retirada</h2>
                        <p class="page-subtitle">Visualize os pedidos prontos para retirada e confirme a entrega.</p>
                    </div>

                    <div class="search-filters">
                        <div class="search-row">
                            <div class="form-group mb-0">
                                <label class="form-label sr-only" for="retirador-search">Buscar Pedidos</label>
                                <div class="relative">
                                    <input type="text" id="retirador-search" class="form-input" placeholder="Buscar por Nº Pedido, Fornecedor, CNPJ ou item...">
                                    <i data-feather="search" class="search-icon"></i>
                                </div>
                            </div>
                            <button class="btn btn-secondary" id="retirador-filter-btn">
                                <i data-feather="filter" class="nav-link-icon"></i>
                                Filtrar
                            </button>
                        </div>
                        <div class="filters-row hidden" id="retirador-filters-area">
                            <div class="form-group mb-0">
                                <label class="form-label" for="retirador-status-filter">Status</label>
                                <select id="retirador-status-filter" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="Aguardando Retirada">Aguardando Retirada</option>
                                    <option value="Retirado">Retirado</option>
                                    <option value="Finalizado">Finalizado</option>
                                </select>
                            </div>
                            <div class="form-group mb-0">
                                <label class="form-label" for="retirador-priority-filter">Prioridade</label>
                                <select id="retirador-priority-filter" class="form-select">
                                    <option value="">Todas</option>
                                    <option value="Normal">Normal</option>
                                    <option value="Alta">Alta</option>
                                    <option value="Urgente">Urgente</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="retirador-orders-container" class="orders-grid">
                        <!-- Orders will be loaded here -->
                    </div>
                    <div id="retirador-pagination" class="pagination-controls text-center mt-4"></div>
                </section>

                <!-- Admin Section -->
                <section id="admin-section" class="section hidden">
                    <div class="page-header">
                        <h2 class="page-title">Administração do Sistema</h2>
                        <p class="page-subtitle">Gerencie usuários, visualize logs e configurações gerais.</p>
                    </div>

                    <div class="card mb-6">
                        <div class="card-header">
                            <h3 class="card-title">Gerenciar Usuários</h3>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-primary" id="manage-users-btn">
                                <i data-feather="users" class="nav-link-icon"></i>
                                Abrir Gerenciamento de Usuários
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Logs de Atividade Recentes</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Data/Hora</th>
                                            <th>Usuário</th>
                                            <th>Ação</th>
                                            <th>Detalhes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logs-table-body">
                                        <!-- Logs will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Reports Section -->
                <section id="reports-section" class="section hidden">
                    <div class="page-header">
                        <h2 class="page-title">Relatórios</h2>
                        <p class="page-subtitle">Análises e estatísticas detalhadas dos pedidos.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Pedidos por Status</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="reportStatusChart"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Performance de Entrega</h3>
                            </div>
                            <div class="card-body">
                                <p><strong>Tempo Médio de Recebimento:</strong> <span id="avg-receive-time">N/A</span> dias</p>
                                <p><strong>Tempo Médio de Retirada:</strong> <span id="avg-retirada-time">N/A</span> dias</p>
                                <p><strong>Pedidos no Prazo:</strong> <span id="on-time-orders">N/A</span></p>
                                <p><strong>Pedidos Atrasados:</strong> <span id="late-orders">N/A</span></p>
                            </div>
                        </div>
                        <div class="card md:col-span-2">
                            <div class="card-header">
                                <h3 class="card-title">Pedidos por Fornecedor</h3>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Fornecedor</th>
                                                <th>Total de Pedidos</th>
                                                <th>Valor Total</th>
                                                <th>Pedidos Finalizados</th>
                                            </tr>
                                        </thead>
                                        <tbody id="supplier-report-table-body">
                                            <!-- Supplier data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

  <script>
// ===== OTIMIZAÇÃO: ESTADO GLOBAL UNIFICADO =====
const AppState = {
    user: null,
    pedidos: [],
    users: [],
    notifications: [],
    currentPedidoDetails: null,
    charts: {},
    isLoading: false
};

// ===== DOM REFERENCES OTIMIZADO =====
const DOM = {
    // Core elements
    loader: document.getElementById('loader'),
    notificationContainer: document.getElementById('notification-container'),
    
    // Login modal
    loginModal: document.getElementById('login-modal'),
    loginForm: document.getElementById('login-form'),
    loginEmail: document.getElementById('login-email'),
    loginPassword: document.getElementById('login-password'),
    
    // App wrapper
    appWrapper: document.getElementById('app-wrapper'),
    sidebar: document.getElementById('sidebar'),
    pageTitle: document.getElementById('page-title'),
    userAvatar: document.getElementById('user-avatar'),
    userName: document.getElementById('user-name'),
    userRole: document.getElementById('user-role'),
    notificationBell: document.getElementById('notification-bell'),
    notificationCount: document.getElementById('notification-count'),
    
    // Navigation
    dashboardBtn: document.getElementById('dashboard-btn'),
    navBuyer: document.getElementById('nav-buyer'),
    buyerBtn: document.getElementById('buyer-btn'),
    navReceiver: document.getElementById('nav-receiver'),
    receiverBtn: document.getElementById('receiver-btn'),
    navRetirador: document.getElementById('nav-retirador'),
    retiradorBtn: document.getElementById('retirador-btn'),
    navAdmin: document.getElementById('nav-admin'),
    adminBtn: document.getElementById('admin-btn'),
    logoutBtn: document.getElementById('logout-btn'),
    
    // Dashboard
    dashboardSection: document.getElementById('dashboard-section'),
    dashboardStats: document.getElementById('dashboard-stats'),
    statusChartCanvas: document.getElementById('statusChart'),
    recentOrdersTableBody: document.getElementById('recent-orders-table-body'),
    
    // Sections
    buyerSection: document.getElementById('buyer-section'),
    receiverSection: document.getElementById('receiver-section'),
    retiradorSection: document.getElementById('retirador-section'),
    adminSection: document.getElementById('admin-section'),
    reportsSection: document.getElementById('reports-section'),
    
    // File upload
    uploadArea: document.getElementById('upload-area'),
    pdfUpload: document.getElementById('pdf-upload'),
    selectedFileDisplay: document.getElementById('selected-file-display'),
    selectedFileName: document.getElementById('selected-file-name'),
    selectedFileSize: document.getElementById('selected-file-size'),
    removeFileBtn: document.getElementById('remove-file-btn'),
    processPdfBtn: document.getElementById('process-pdf'),
    
    // Search and filters
    buyerSearch: document.getElementById('buyer-search'),
    buyerFilterBtn: document.getElementById('buyer-filter-btn'),
    buyerFiltersArea: document.getElementById('buyer-filters-area'),
    buyerStatusFilter: document.getElementById('buyer-status-filter'),
    buyerPriorityFilter: document.getElementById('buyer-priority-filter'),
    buyerOrdersContainer: document.getElementById('buyer-orders-container'),
    
    receiverSearch: document.getElementById('receiver-search'),
    receiverFilterBtn: document.getElementById('receiver-filter-btn'),
    receiverFiltersArea: document.getElementById('receiver-filters-area'),
    receiverStatusFilter: document.getElementById('receiver-status-filter'),
    receiverPriorityFilter: document.getElementById('receiver-priority-filter'),
    receiverOrdersContainer: document.getElementById('receiver-orders-container'),
    
    retiradorSearch: document.getElementById('retirador-search'),
    retiradorFilterBtn: document.getElementById('retirador-filter-btn'),
    retiradorFiltersArea: document.getElementById('retirador-filters-area'),
    retiradorStatusFilter: document.getElementById('retirador-status-filter'),
    retiradorPriorityFilter: document.getElementById('retirador-priority-filter'),
    retiradorOrdersContainer: document.getElementById('retirador-orders-container'),
    
    // Modals
    registerModal: document.getElementById('register-modal'),
    closeRegisterBtn: document.getElementById('close-register-btn'),
    registerForm: document.getElementById('register-form'),
    registerName: document.getElementById('register-name'),
    registerEmail: document.getElementById('register-email'),
    registerPassword: document.getElementById('register-password'),
    registerRole: document.getElementById('register-role'),
    cancelRegisterBtn: document.getElementById('cancel-register-btn'),
    openRegisterModalFromAdmin: document.getElementById('open-register-modal-from-admin'),
    
    orderDetailsModal: document.getElementById('order-details-modal'),
    closeDetailsBtn: document.getElementById('close-details-btn'),
    detailsModalTitle: document.getElementById('details-modal-title'),
    detailsModalBody: document.getElementById('details-modal-body'),
    detailsModalFooter: document.getElementById('details-modal-footer'),
    
    statusModal: document.getElementById('status-modal'),
    closeStatusBtn: document.getElementById('close-status-btn'),
    statusModalTitle: document.getElementById('status-modal-title'),
    statusForm: document.getElementById('status-form'),
    statusPedidoId: document.getElementById('status-pedido-id'),
    statusSelect: document.getElementById('status-select'),
    statusObservacoes: document.getElementById('status-observacoes'),
    additionalFields: document.getElementById('additional-fields'),
    cancelStatusBtn: document.getElementById('cancel-status-btn'),
    
    // Admin
    manageUsersBtn: document.getElementById('manage-users-btn'),
    usersModal: document.getElementById('users-modal'),
    closeUsersBtn: document.getElementById('close-users-btn'),
    usersTableBody: document.getElementById('users-table-body'),
    logsTableBody: document.getElementById('logs-table-body'),
    
    // Reports
    reportStatusBtn: document.getElementById('report-status-btn'),
    reportSupplierBtn: document.getElementById('report-supplier-btn'),
    reportPerformanceBtn: document.getElementById('report-performance-btn'),
    reportStatusChartCanvas: document.getElementById('reportStatusChart'),
    avgReceiveTime: document.getElementById('avg-receive-time'),
    avgRetiradaTime: document.getElementById('avg-retirada-time'),
    onTimeOrders: document.getElementById('on-time-orders'),
    lateOrders: document.getElementById('late-orders'),
    supplierReportTableBody: document.getElementById('supplier-report-table-body')
};

// ===== CONSTANTS =====
const ROLES = {
    ADMIN: 'admin',
    COMPRADOR: 'comprador',
    RECEBEDOR: 'recebedor',
    RETIRADOR: 'retirador'
};

const STATUS = {
    PENDENTE: 'Pendente',
    EM_TRANSITO: 'Em Trânsito',
    RECEBIDO: 'Recebido',
    AGUARDANDO_RETIRADA: 'Aguardando Retirada',
    RETIRADO: 'Retirado',
    FINALIZADO: 'Finalizado',
    CANCELADO: 'Cancelado'
};

const STATUS_COLORS = {
    'Pendente': { bg: '#FEF3C7', text: '#F59E0B' },
    'Em Trânsito': { bg: '#DBEAFE', text: '#3B82F6' },
    'Recebido': { bg: '#D1FAE5', text: '#10B981' },
    'Aguardando Retirada': { bg: '#EDE9FE', text: '#8B5CF6' },
    'Retirado': { bg: '#F3F4F6', text: '#6B7280' },
    'Finalizado': { bg: '#F3F4F6', text: '#6B7280' },
    'Cancelado': { bg: '#FEE2E2', text: '#EF4444' }
};

const PRIORITY_COLORS = {
    'Normal': { bg: '#DBEAFE', text: '#3B82F6' },
    'Alta': { bg: '#FEF3C7', text: '#F59E0B' },
    'Urgente': { bg: '#FEE2E2', text: '#EF4444' }
};

// ===== UTILITY FUNCTIONS =====
function showLoader(show, text = 'Carregando...') {
    if (AppState.isLoading === show) return;
    AppState.isLoading = show;
    
    if (DOM.loader) {
        DOM.loader.classList.toggle('hidden', !show);
        const loaderText = DOM.loader.querySelector('.loader-text');
        if (loaderText) {
            loaderText.textContent = text;
        }
    }
}

function showNotification(message, type = 'info', duration = 5000) {
    if (!DOM.notificationContainer) return;
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    
    const iconMap = {
        success: 'check-circle',
        error: 'alert-circle',
        warning: 'alert-triangle',
        info: 'info'
    };
    
    notification.innerHTML = `
        <div class="notification-header">
            <div class="flex items-center gap-2">
                <i data-feather="${iconMap[type]}"></i>
                <span class="notification-title">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
            </div>
            <button class="notification-close">
                <i data-feather="x"></i>
            </button>
        </div>
        <div class="notification-message">${message}</div>
    `;
    
    DOM.notificationContainer.appendChild(notification);
    feather.replace();
    
    const closeBtn = notification.querySelector('.notification-close');
    closeBtn.addEventListener('click', () => notification.remove());
    
    if (duration > 0) {
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, duration);
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value || 0);
}

function formatDate(date) {
    if (!date) return 'N/A';
    return new Intl.DateTimeFormat('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    }).format(new Date(date));
}

function formatDateShort(date) {
    if (!date) return 'N/A';
    return new Intl.DateTimeFormat('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    }).format(new Date(date));
}

function getStatusBadge(status) {
    const colors = STATUS_COLORS[status] || { bg: '#F3F4F6', text: '#6B7280' };
    return `<span class="badge" style="background-color: ${colors.bg}; color: ${colors.text};">${status}</span>`;
}

function getPriorityBadge(priority) {
    const colors = PRIORITY_COLORS[priority] || { bg: '#DBEAFE', text: '#3B82F6' };
    return `<span class="badge" style="background-color: ${colors.bg}; color: ${colors.text};">${priority}</span>`;
}

function getUserInitials(name) {
    return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ===== AUTHENTICATION FUNCTIONS =====
function initializeApp() {
    console.log('🚀 Inicializando aplicação...');
    
    showLoader(true, 'Verificando sistema...');
    
    if (typeof google !== 'undefined' && google.script) {
        google.script.run
            .withSuccessHandler(handleSystemCheck)
            .withFailureHandler(handleSystemError)
            .isSystemInitialized();
    } else {
        setTimeout(() => {
            showLoader(false);
            showLoginModal();
        }, 1000);
    }
}

function handleSystemCheck(isInitialized) {
    if (!isInitialized) {
        showLoader(false);
        showNotification('Sistema precisa ser configurado. Execute o menu "Sistema de Pedidos > Configuração Inicial" na planilha.', 'warning', 0);
        showLoginModal();
        return;
    }
    
    google.script.run
        .withSuccessHandler(handleSessionCheck)
        .withFailureHandler(() => showLoginModal())
        .checkUserSession();
}

function handleSystemError(error) {
    console.error('Erro do sistema:', error);
    showLoader(false);
    showNotification('Erro crítico: Sistema não configurado corretamente.', 'error', 0);
    showLoginModal();
}

function handleSessionCheck(user) {
    showLoader(false);
    
    if (user && user.email) {
        AppState.user = user;
        initializeMainApp();
    } else {
        showLoginModal();
    }
}

function showLoginModal() {
    console.log('🔑 Mostrando modal de login...');
    if (DOM.loginModal) {
        DOM.loginModal.classList.remove('hidden');
        if (DOM.loginEmail) {
            DOM.loginEmail.focus();
        }
        setupLoginButtonListener();
    }
}

function handleLogin(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    const email = DOM.loginEmail?.value?.trim() || '';
    const password = DOM.loginPassword?.value?.trim() || '';
    
    if (!email || !password) {
        showNotification('Preencha email e senha!', 'warning');
        return;
    }
    
    showLoader(true, 'Fazendo login...');
    
    if (typeof google === 'undefined' || !google.script) {
        showLoader(false);
        showNotification('Erro: Google Apps Script não está disponível!', 'error');
        return;
    }
    
    google.script.run
        .withSuccessHandler(handleLoginResponse)
        .withFailureHandler(handleError)
        .loginUser(email, password);
}

function handleLoginResponse(response) {
    showLoader(false);
    
    if (!response) {
        showNotification('Resposta nula do servidor!', 'error');
        return;
    }
    
    if (response.success) {
        AppState.user = response.user;
        if (DOM.loginModal) DOM.loginModal.classList.add('hidden');
        if (DOM.appWrapper) DOM.appWrapper.classList.remove('hidden');
        initializeMainApp();
        showNotification('Login realizado com sucesso!', 'success');
    } else {
        showNotification(response.message || 'Erro no login', 'error');
    }
}

function handleError(error) {
    showLoader(false);
    let errorMessage = 'Erro de conexão com o servidor.';
    
    if (error && error.message) {
        errorMessage = error.message;
    } else if (typeof error === 'string') {
        errorMessage = error;
    }
    
    showNotification(errorMessage, 'error', 10000);
    console.error('❌ Erro detalhado:', error);
}

function handleLogout() {
    showLoader(true, 'Fazendo logout...');
    
    if (typeof google !== 'undefined' && google.script) {
        google.script.run
            .withSuccessHandler(() => window.location.reload())
            .withFailureHandler(handleError)
            .logoutUser();
    } else {
        window.location.reload();
    }
}

// ===== MAIN APP INITIALIZATION =====
function initializeMainApp() {
    console.log('🎯 Inicializando aplicação principal...');
    if (DOM.loginModal) DOM.loginModal.classList.add('hidden');
    if (DOM.appWrapper) DOM.appWrapper.classList.remove('hidden');
    
    showLoader(true, 'Carregando dados...');
    
    google.script.run
        .withSuccessHandler(initialData => {
            showLoader(false);
            if (initialData) {
                AppState.user = initialData.user;
                AppState.pedidos = initialData.pedidos || [];
                AppState.users = initialData.usuarios || [];
                AppState.notifications = initialData.notifications || [];
                
                setupUserInterface();
                renderDashboardStats(initialData.dashboardStats);
                renderRecentOrders(initialData.recentOrders);
                renderStatusChart(initialData.dashboardStats);
                handleNotifications(initialData.notifications);
            }
            setupNavigation();
            setupEventListeners();
            feather.replace();
            showSection('dashboard-section', 'Dashboard');
            if (DOM.dashboardBtn) DOM.dashboardBtn.classList.add('active');
        })
        .withFailureHandler(handleError)
        .getInitialAppData();
}

function setupUserInterface() {
    const user = AppState.user;
    console.log('🎨 Configurando interface do usuário');
    
    if (DOM.userAvatar && user.name) {
        DOM.userAvatar.textContent = getUserInitials(user.name);
    }
    
    if (DOM.userName && user.name) {
        DOM.userName.textContent = user.name;
    }
    
    if (DOM.userRole && user.role) {
        DOM.userRole.textContent = getRoleDisplayName(user.role);
    }
    
    // Show/hide navigation based on role
    if (DOM.navBuyer) {
        DOM.navBuyer.style.display = [ROLES.ADMIN, ROLES.COMPRADOR].includes(user.role) ? 'block' : 'none';
    }
    if (DOM.navReceiver) {
        DOM.navReceiver.style.display = [ROLES.ADMIN, ROLES.RECEBEDOR].includes(user.role) ? 'block' : 'none';
    }
    if (DOM.navRetirador) {
        DOM.navRetirador.style.display = [ROLES.ADMIN, ROLES.RETIRADOR].includes(user.role) ? 'block' : 'none';
    }
    if (DOM.navAdmin) {
        DOM.navAdmin.style.display = user.role === ROLES.ADMIN ? 'block' : 'none';
    }
}

function getRoleDisplayName(role) {
    const roleNames = {
        [ROLES.ADMIN]: 'Administrador',
        [ROLES.COMPRADOR]: 'Comprador',
        [ROLES.RECEBEDOR]: 'Recebedor',
        [ROLES.RETIRADOR]: 'Retirador'
    };
    return roleNames[role] || role;
}

function setupNavigation() {
    const navItems = [
        { btn: DOM.dashboardBtn, section: 'dashboard-section', title: 'Dashboard', load: loadDashboard },
        { btn: DOM.buyerBtn, section: 'buyer-section', title: 'Painel do Comprador', load: loadBuyerSection },
        { btn: DOM.receiverBtn, section: 'receiver-section', title: 'Painel de Recebimento', load: loadReceiverSection },
        { btn: DOM.retiradorBtn, section: 'retirador-section', title: 'Painel de Retirada', load: loadRetiradorSection },
        { btn: DOM.adminBtn, section: 'admin-section', title: 'Administração', load: loadAdminSection },
        { btn: DOM.reportStatusBtn, section: 'reports-section', title: 'Relatórios', load: loadReportsSection },
        { btn: DOM.reportSupplierBtn, section: 'reports-section', title: 'Relatórios', load: loadReportsSection },
        { btn: DOM.reportPerformanceBtn, section: 'reports-section', title: 'Relatórios', load: loadReportsSection }
    ];
    
    navItems.forEach(item => {
        if (item.btn) {
            item.btn.addEventListener('click', () => {
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                item.btn.classList.add('active');
                showSection(item.section, item.title);
                if (item.load) item.load();
            });
        }
    });
}

function showSection(sectionId, title) {
    document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
    });
    
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.remove('hidden');
    }
    
    if (DOM.pageTitle) {
        DOM.pageTitle.textContent = title;
    }
}

// ===== EVENT LISTENERS =====
const debouncedSearch = debounce((section) => {
    searchPedidos(section, 1);
}, 500);

function setupEventListeners() {
    console.log('🎯 Configurando event listeners...');
    
    if (DOM.logoutBtn) {
        DOM.logoutBtn.addEventListener('click', handleLogout);
    }
    
    setupFileUploadListeners();
    setupSearchAndFilterListeners();
    setupModalListeners();
    setupFormListeners();
    setupAdminListeners();
    setupNotificationListeners();
    
    console.log('✅ Event listeners configurados');
}

function setupSearchAndFilterListeners() {
    const sections = ['buyer', 'receiver', 'retirador'];
    
    sections.forEach(section => {
        const search = DOM[`${section}Search`];
        const filterBtn = DOM[`${section}FilterBtn`];
        const filtersArea = DOM[`${section}FiltersArea`];
        const statusFilter = DOM[`${section}StatusFilter`];
        const priorityFilter = DOM[`${section}PriorityFilter`];
        
        if (search) {
            search.addEventListener('input', () => debouncedSearch(section));
        }
        
        if (filterBtn && filtersArea) {
            filterBtn.addEventListener('click', () => filtersArea.classList.toggle('hidden'));
        }
        
        if (statusFilter) {
            statusFilter.addEventListener('change', () => searchPedidos(section, 1));
        }
        
        if (priorityFilter) {
            priorityFilter.addEventListener('change', () => searchPedidos(section, 1));
        }
    });
}

function setupFileUploadListeners() {
    if (!DOM.pdfUpload || !DOM.uploadArea || !DOM.processPdfBtn || !DOM.removeFileBtn) return;
    
    DOM.pdfUpload.addEventListener('change', handleFileSelection);
    DOM.uploadArea.addEventListener('click', () => DOM.pdfUpload.click());
    DOM.uploadArea.addEventListener('dragover', handleDragOver);
    DOM.uploadArea.addEventListener('dragleave', handleDragLeave);
    DOM.uploadArea.addEventListener('drop', handleFileDrop);
    DOM.removeFileBtn.addEventListener('click', clearSelectedFile);
    DOM.processPdfBtn.addEventListener('click', handlePdfProcessing);
}

function setupModalListeners() {
    const modals = [
        { modal: DOM.orderDetailsModal, closeBtn: DOM.closeDetailsBtn },
        { modal: DOM.statusModal, closeBtn: DOM.closeStatusBtn },
        { modal: DOM.registerModal, closeBtn: DOM.closeRegisterBtn },
        { modal: DOM.usersModal, closeBtn: DOM.closeUsersBtn }
    ];
    
    modals.forEach(({modal, closeBtn}) => {
        if (closeBtn) {
            closeBtn.addEventListener('click', () => modal?.classList.add('hidden'));
        }
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        }
    });
    
    if (DOM.cancelStatusBtn) {
        DOM.cancelStatusBtn.addEventListener('click', () => DOM.statusModal?.classList.add('hidden'));
    }
    
    if (DOM.cancelRegisterBtn) {
        DOM.cancelRegisterBtn.addEventListener('click', () => DOM.registerModal?.classList.add('hidden'));
    }
}

function setupFormListeners() {
    if (DOM.statusForm) {
        DOM.statusForm.addEventListener('submit', handleStatusUpdate);
    }
    
    if (DOM.registerForm) {
        DOM.registerForm.addEventListener('submit', handleRegisterUser);
    }
}

function setupAdminListeners() {
    if (DOM.manageUsersBtn) {
        DOM.manageUsersBtn.addEventListener('click', () => {
            loadUsers();
            DOM.usersModal?.classList.remove('hidden');
        });
    }
    
    if (DOM.openRegisterModalFromAdmin) {
        DOM.openRegisterModalFromAdmin.addEventListener('click', () => {
            DOM.registerModal?.classList.remove('hidden');
        });
    }
    
    const reportBtns = [DOM.reportStatusBtn, DOM.reportSupplierBtn, DOM.reportPerformanceBtn];
    reportBtns.forEach(btn => {
        if (btn) {
            btn.addEventListener('click', () => {
                showSection('reports-section', 'Relatórios');
                loadReportsSection();
            });
        }
    });
}

function setupNotificationListeners() {
    if (DOM.notificationBell) {
        DOM.notificationBell.addEventListener('click', toggleNotifications);
    }
}

function setupLoginButtonListener() {
    console.log('🔧 Configurando listener do botão de login...');
    
    const loginBtn = document.getElementById('login-submit-btn');
    
    if (loginBtn) {
        loginBtn.onclick = null;
        loginBtn.removeEventListener('click', handleLogin);
        
        loginBtn.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            handleLogin(event);
        });
        
        console.log('✅ Login button configurado com sucesso');
    }
    
    if (DOM.loginPassword) {
        DOM.loginPassword.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleLogin(event);
            }
        });
    }
}

// ===== FILE UPLOAD FUNCTIONS =====
function handleFileSelection(event) {
    const file = event.target.files[0];
    if (file) {
        console.log('📁 Arquivo selecionado:', file.name);
        displaySelectedFile(file);
    }
}

function handleDragOver(event) {
    event.preventDefault();
    DOM.uploadArea?.classList.add('dragover');
}

function handleDragLeave(event) {
    event.preventDefault();
    DOM.uploadArea?.classList.remove('dragover');
}

function handleFileDrop(event) {
    event.preventDefault();
    DOM.uploadArea?.classList.remove('dragover');
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        if (file.type === 'application/pdf') {
            DOM.pdfUpload.files = files;
            displaySelectedFile(file);
        } else {
            showNotification('Apenas arquivos PDF são aceitos.', 'warning');
        }
    }
}

function displaySelectedFile(file) {
    if (DOM.selectedFileName) DOM.selectedFileName.textContent = file.name;
    if (DOM.selectedFileSize) DOM.selectedFileSize.textContent = formatFileSize(file.size);
    DOM.selectedFileDisplay?.classList.remove('hidden');
    if (DOM.processPdfBtn) DOM.processPdfBtn.disabled = false;
    feather.replace();
}

function clearSelectedFile() {
    if (DOM.pdfUpload) DOM.pdfUpload.value = '';
    DOM.selectedFileDisplay?.classList.add('hidden');
    if (DOM.processPdfBtn) DOM.processPdfBtn.disabled = true;
}

function handlePdfProcessing() {
    const file = DOM.pdfUpload?.files[0];
    if (!file) {
        showNotification('Nenhum arquivo selecionado.', 'warning');
        return;
    }
    
    console.log('⚙️ Processando PDF:', file.name);
    showLoader(true, 'Processando PDF...');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const fileInfo = {
            name: file.name,
            type: file.type,
            data: e.target.result.split(',')[1]
        };
        
        google.script.run
            .withSuccessHandler(handlePdfProcessResponse)
            .withFailureHandler(handleError)
            .processAndSavePDF(fileInfo);
    };
    
    reader.onerror = function() {
        showLoader(false);
        showNotification('Erro ao ler arquivo.', 'error');
    };
    
    reader.readAsDataURL(file);
}

function handlePdfProcessResponse(response) {
    showLoader(false);
    
    if (response && response.success) {
        showNotification(response.message || 'PDF processado com sucesso!', 'success');
        clearSelectedFile();
        
        if (DOM.buyerBtn?.classList.contains('active')) {
            loadBuyerSection();
        }
        
        if (DOM.dashboardBtn?.classList.contains('active')) {
            loadDashboard();
        }
    } else {
        showNotification(response?.message || 'Erro ao processar PDF', 'error');
    }
}

// ===== DATA LOADING FUNCTIONS =====
function loadDashboard() {
    if (!DOM.dashboardStats || !DOM.recentOrdersTableBody) return;
    
    showLoader(true, 'Carregando dashboard...');
    
    google.script.run
        .withSuccessHandler(dados => {
            renderDashboardStats(dados.dashboardStats);
            renderRecentOrders(dados.recentOrders);
            renderStatusChart(dados.dashboardStats);
            showLoader(false);
        })
        .withFailureHandler(error => {
            showLoader(false);
            handleError(error);
        })
        .getDadosCompletos();
}

function renderDashboardStats(stats) {
    if (!DOM.dashboardStats) return;
    
    const statsCards = [
        { title: 'Total de Pedidos', value: stats.totalPedidos || 0, icon: 'package', color: '#3B82F6' },
        { title: 'Pendentes', value: stats.pendentes || 0, icon: 'clock', color: '#F59E0B' },
        { title: 'Em Trânsito', value: stats.emTransito || 0, icon: 'truck', color: '#3B82F6' },
        { title: 'Recebidos', value: stats.recebidos || 0, icon: 'check-circle', color: '#10B981' },
        { title: 'Aguardando Retirada', value: stats.aguardandoRetirada || 0, icon: 'box', color: '#8B5CF6' },
        { title: 'Finalizados', value: stats.finalizados || 0, icon: 'check', color: '#6B7280' },
        { title: 'Valor Total', value: formatCurrency(stats.valorTotal), icon: 'dollar-sign', color: '#10B981' }
    ];
    
    if (AppState.user?.role === ROLES.COMPRADOR && stats.meusPedidos !== undefined) {
        statsCards.splice(1, 0, 
            { title: 'Meus Pedidos', value: stats.meusPedidos, icon: 'user', color: '#8B5CF6' },
            { title: 'Meus Valores', value: formatCurrency(stats.meusValores), icon: 'credit-card', color: '#F59E0B' }
        );
    }
    
    DOM.dashboardStats.innerHTML = statsCards.map(stat => `
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">${stat.title}</span>
                <i data-feather="${stat.icon}" class="stat-icon" style="color: ${stat.color};"></i>
            </div>
            <div class="stat-value">${stat.value}</div>
        </div>
    `).join('');
    
    feather.replace();
}

function renderRecentOrders(orders) {
    if (!DOM.recentOrdersTableBody) return;
    
    if (!orders || orders.length === 0) {
        DOM.recentOrdersTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum pedido encontrado</td></tr>';
        return;
    }
    
    DOM.recentOrdersTableBody.innerHTML = orders.slice(0, 5).map(order => `
        <tr>
            <td class="font-medium">#${order.NumeroPedidoPDF || 'S/N'}</td>
            <td>${order.Fornecedor}</td>
            <td>${getStatusBadge(order.Status)}</td>
            <td class="font-medium">${formatCurrency(order.ValorTotal)}</td>
        </tr>
    `).join('');
}

function renderStatusChart(stats) {
    if (!DOM.statusChartCanvas) return;
    
    const ctx = DOM.statusChartCanvas.getContext('2d');
    
    if (AppState.charts.statusChart) {
        AppState.charts.statusChart.destroy();
    }
    
    AppState.charts.statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Pendente', 'Em Trânsito', 'Recebido', 'Aguardando Retirada', 'Finalizado'],
            datasets: [{
                data: [
                    stats.pendentes || 0,
                    stats.emTransito || 0,
                    stats.recebidos || 0,
                    stats.aguardandoRetirada || 0,
                    stats.finalizados || 0
                ],
                backgroundColor: ['#F59E0B', '#3B82F6', '#10B981', '#8B5CF6', '#6B7280'],
                borderWidth: 2,
                borderColor: '#FFFFFF'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function loadBuyerSection() {
    searchPedidos('buyer');
}

function loadReceiverSection() {
    searchPedidos('receiver');
}

function loadRetiradorSection() {
    searchPedidos('retirador');
}

function loadAdminSection() {
    if (typeof google !== 'undefined' && google.script) {
        google.script.run
            .withSuccessHandler(renderLogs)
            .withFailureHandler(() => {
                if (DOM.logsTableBody) {
                    DOM.logsTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Logs não disponíveis</td></tr>';
                }
            })
            .getRecentLogs();
    }
}

function loadReportsSection() {
    showLoader(true, 'Carregando relatórios...');
    
    Promise.all([
        new Promise(resolve => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(() => resolve({}))
                .generateReport('pedidos_por_status');
        }),
        new Promise(resolve => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(() => resolve({}))
                .generateReport('pedidos_por_fornecedor');
        }),
        new Promise(resolve => {
            google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(() => resolve({}))
                .generateReport('performance_entrega');
        })
    ]).then(([statusReport, supplierReport, performanceReport]) => {
        renderReportStatusChart(statusReport);
        renderSupplierReport(supplierReport);
        renderPerformanceReport(performanceReport);
        showLoader(false);
    });
}

// ===== SEARCH FUNCTIONS =====
function searchPedidos(section, pagina = 1) {
    const searchInputs = {
        buyer: DOM.buyerSearch,
        receiver: DOM.receiverSearch,
        retirador: DOM.retiradorSearch
    };
    const statusFilters = {
        buyer: DOM.buyerStatusFilter,
        receiver: DOM.receiverStatusFilter,
        retirador: DOM.retiradorStatusFilter
    };
    const priorityFilters = {
        buyer: DOM.buyerPriorityFilter,
        receiver: DOM.receiverPriorityFilter,
        retirador: DOM.retiradorPriorityFilter
    };
    const containers = {
        buyer: DOM.buyerOrdersContainer,
        receiver: DOM.receiverOrdersContainer,
        retirador: DOM.retiradorOrdersContainer
    };
    
    const searchTerm = searchInputs[section]?.value || '';
    const statusFilter = statusFilters[section]?.value || '';
    const priorityFilter = priorityFilters[section]?.value || '';
    
    const filtros = {};
    if (statusFilter) filtros.status = statusFilter;
    if (priorityFilter) filtros.prioridade = priorityFilter;
    
    let loaderTimeout = setTimeout(() => showLoader(true, 'Buscando pedidos...'), 300);
    
    google.script.run
        .withSuccessHandler(result => {
            clearTimeout(loaderTimeout);
            showLoader(false);
            const container = containers[section];
            if (container) {
                container.innerHTML = result.html;
                feather.replace();
            }
            renderPagination(section, result.paginaAtual, result.totalPaginas);
        })
        .withFailureHandler(error => {
            clearTimeout(loaderTimeout);
            showLoader(false);
            handleError(error);
        })
        .getPedidosPaginados(pagina, 12, searchTerm, filtros);
}

function renderPagination(section, paginaAtual, totalPaginas) {
    let pagContainer = document.getElementById(`${section}-pagination`);
    if (!pagContainer) {
        pagContainer = document.createElement('div');
        pagContainer.id = `${section}-pagination`;
        pagContainer.className = 'pagination-controls text-center mt-4';
        const ordersContainer = DOM[`${section}OrdersContainer`];
        if (ordersContainer && ordersContainer.parentNode) {
            ordersContainer.parentNode.appendChild(pagContainer);
        }
    }
    
    pagContainer.innerHTML = '';
    if (totalPaginas <= 1) {
        pagContainer.style.display = 'none';
        return;
    }
    
    pagContainer.style.display = 'block';
    let html = '';
    
    if (paginaAtual > 1) {
        html += `<button class="btn btn-secondary btn-sm" onclick="searchPedidos('${section}', ${paginaAtual - 1})">Anterior</button> `;
    }
    
    html += `<span class="mx-2">Página ${paginaAtual} de ${totalPaginas}</span>`;
    
    if (paginaAtual < totalPaginas) {
        html += ` <button class="btn btn-secondary btn-sm" onclick="searchPedidos('${section}', ${paginaAtual + 1})">Próxima</button>`;
    }
    
    pagContainer.innerHTML = html;
}

// ===== ORDER DETAILS =====
function openOrderDetails(pedidoId) {
    let order = AppState.pedidos.find(p => p.PedidoID === pedidoId);
    
    if (!order) {
        showLoader(true, 'Carregando detalhes...');
        google.script.run
            .withSuccessHandler(pedidos => {
                showLoader(false);
                order = pedidos.find(p => p.PedidoID === pedidoId);
                if (order) {
                    displayOrderDetails(order);
                } else {
                    showNotification('Pedido não encontrado', 'error');
                }
            })
            .withFailureHandler(handleError)
            .getPedidosComItens();
        return;
    }
    
    displayOrderDetails(order);
}

function displayOrderDetails(order) {
    if (!DOM.detailsModalTitle || !DOM.detailsModalBody || !DOM.orderDetailsModal) return;
    
    AppState.currentPedidoDetails = order;
    
    DOM.detailsModalTitle.textContent = `Pedido #${order.NumeroPedidoPDF || 'S/N'}`;
    
    const itemsTable = order.Itens && order.Itens.length > 0 ? `
        <div class="table-container mt-4">
            <table class="table">
                <thead>
                    <tr>
                        <th>Descrição</th>
                        <th>Qtd. Solicitada</th>
                        <th>Qtd. Recebida</th>
                        <th>Valor Unitário</th>
                        <th>Total</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${order.Itens.map(item => `
                        <tr>
                            <td>${item.Descricao}</td>
                            <td>${item.Quantidade}</td>
                            <td>${item.QuantidadeRecebida || 0}</td>
                            <td>${formatCurrency(item.ValorUnitario)}</td>
                            <td>${formatCurrency(item.Quantidade * item.ValorUnitario)}</td>
                            <td>${getStatusBadge(item.StatusItem || order.Status)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    ` : '<p class="text-gray-500">Nenhum item encontrado.</p>';
    
    DOM.detailsModalBody.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <h4 class="font-semibold mb-2">Informações Gerais</h4>
                <div class="space-y-2">
                    <p><strong>Fornecedor:</strong> ${order.Fornecedor}</p>
                    <p><strong>CNPJ:</strong> ${order.CNPJ}</p>
                    <p><strong>Status:</strong> ${getStatusBadge(order.Status)}</p>
                    <p><strong>Data de Envio:</strong> ${formatDate(order.DataEnvio)}</p>
                    ${order.DataPrevista ? `<p><strong>Data Prevista:</strong> ${formatDate(order.DataPrevista)}</p>` : ''}
                    <p><strong>Valor Total:</strong> ${formatCurrency(order.ValorTotal)}</p>
                    ${order.Prioridade ? `<p><strong>Prioridade:</strong> ${getPriorityBadge(order.Prioridade)}</p>` : ''}
                    ${order.AreaDestino ? `<p><strong>Área Destino:</strong> ${order.AreaDestino}</p>` : ''}
                </div>
            </div>
            <div>
                <h4 class="font-semibold mb-2">Histórico</h4>
                <div class="space-y-2">
                    <p><strong>Enviado por:</strong> ${order.EnviadoPorNome || 'N/A'}</p>
                    ${order.RecebidoPorNome ? `<p><strong>Recebido por:</strong> ${order.RecebidoPorNome}</p>` : ''}
                    ${order.DataRecebimento ? `<p><strong>Data Recebimento:</strong> ${formatDate(order.DataRecebimento)}</p>` : ''}
                    ${order.RetiradoPorNome ? `<p><strong>Retirado por:</strong> ${order.RetiradoPorNome}</p>` : ''}
                    ${order.DataRetirada ? `<p><strong>Data Retirada:</strong> ${formatDate(order.DataRetirada)}</p>` : ''}
                </div>
            </div>
        </div>
        
        ${order.Observacoes ? `
        <div class="mb-4">
            <h4 class="font-semibold mb-2">Observações Iniciais</h4>
            <p class="text-gray-600">${order.Observacoes}</p>
        </div>
        ` : ''}
        
        ${order.ObservacoesRecebimento ? `
        <div class="mb-4">
            <h4 class="font-semibold mb-2">Observações do Recebimento</h4>
            <p class="text-gray-600">${order.ObservacoesRecebimento}</p>
        </div>
        ` : ''}
        
        ${order.ObservacoesRetirada ? `
        <div class="mb-4">
            <h4 class="font-semibold mb-2">Observações da Retirada</h4>
            <p class="text-gray-600">${order.ObservacoesRetirada}</p>
        </div>
        ` : ''}
        
        <div>
            <h4 class="font-semibold mb-2">Itens do Pedido</h4>
            ${itemsTable}
        </div>
    `;
    
    DOM.orderDetailsModal.classList.remove('hidden');
    feather.replace();
}

// ===== STATUS MANAGEMENT =====
function openStatusModal(pedidoId, action) {
    const order = AppState.pedidos.find(p => p.PedidoID === pedidoId) || AppState.currentPedidoDetails;
    if (!order || !DOM.statusPedidoId || !DOM.additionalFields || !DOM.statusModalTitle || !DOM.statusSelect || !DOM.statusObservacoes || !DOM.statusModal) return;
    
    DOM.statusPedidoId.value = pedidoId;
    DOM.additionalFields.innerHTML = '';
    
    let title = '';
    let statusOptions = '';
    
    switch (action) {
        case 'receber':
            title = 'Confirmar Recebimento';
            statusOptions = '<option value="Recebido">Recebido</option>';
            setupReceiveFields(order);
            break;
            
        case 'retirar':
            title = 'Confirmar Retirada';
            statusOptions = '<option value="Retirado">Retirado</option><option value="Finalizado">Finalizado</option>';
            setupRetireFields(order);
            break;
            
        case 'definir_retirador':
            title = 'Definir Responsável pela Retirada';
            statusOptions = '<option value="Aguardando Retirada">Aguardando Retirada</option>';
            setupRetiradorFields();
            break;
            
        case 'update_status':
        default:
            title = 'Atualizar Status do Pedido';
            statusOptions = `
                <option value="">Selecione um status</option>
                <option value="Pendente">Pendente</option>
                <option value="Em Trânsito">Em Trânsito</option>
                <option value="Recebido">Recebido</option>
                <option value="Aguardando Retirada">Aguardando Retirada</option>
                <option value="Retirado">Retirado</option>
                <option value="Finalizado">Finalizado</option>
                <option value="Cancelado">Cancelado</option>
            `;
            break;
    }
    
    DOM.statusModalTitle.textContent = title;
    DOM.statusSelect.innerHTML = statusOptions;
    DOM.statusObservacoes.value = '';
    
    DOM.statusModal.classList.remove('hidden');
}

function setupReceiveFields(order) {
    if (!DOM.additionalFields) return;
    
    const itemsHtml = order.Itens ? order.Itens.map(item => `
        <div class="grid grid-cols-3 gap-4 items-end mb-4 p-4 border rounded-lg">
            <div>
                <label class="form-label text-sm">${item.Descricao}</label>
                <p class="text-xs text-gray-500">Qtd. Solicitada: ${item.Quantidade}</p>
            </div>
            <div class="form-group mb-0">
                <label class="form-label text-sm">Qtd. Recebida</label>
                <input type="number" class="form-input" name="qtd_recebida_${item.ItemID}" 
                       value="${item.Quantidade}" min="0" max="${item.Quantidade}">
            </div>
            <div class="form-group mb-0">
                <label class="form-label text-sm">Divergências</label>
                <input type="text" class="form-input" name="divergencias_${item.ItemID}" 
                       placeholder="Descreva divergências...">
            </div>
        </div>
    `).join('') : '';
    
    DOM.additionalFields.innerHTML = `
        <div class="form-group">
            <label class="form-label">Verificação dos Itens</label>
            <div class="border rounded-lg p-4">
                ${itemsHtml}
            </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
                <label class="form-label">URL da Nota Fiscal</label>
                <input type="url" id="nf-url" class="form-input" placeholder="https://...">
            </div>
            <div class="form-group">
                <label class="form-label">URL do Boleto</label>
                <input type="url" id="boleto-url" class="form-input" placeholder="https://...">
            </div>
        </div>
    `;
}

function setupRetireFields(order) {
    if (!DOM.additionalFields) return;
    
    DOM.additionalFields.innerHTML = `
        <div class="form-group">
            <label class="form-label">Confirmar Retirada</label>
            <div class="form-group">
                <label class="form-checkbox-wrapper">
                    <input type="checkbox" id="confirm-items" class="form-checkbox">
                    <span>Confirmo que todos os itens foram retirados conforme solicitado</span>
                </label>
            </div>
            <div class="form-group">
                <label class="form-checkbox-wrapper">
                    <input type="checkbox" id="confirm-delivery" class="form-checkbox">
                    <span>Confirmo a entrega na área de destino: ${order.AreaDestino || 'N/A'}</span>
                </label>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Divergências ou Problemas Encontrados</label>
            <textarea id="retirada-divergencias" class="form-textarea" rows="3" 
                      placeholder="Descreva qualquer problema ou divergência encontrada..."></textarea>
        </div>
    `;
}

function setupRetiradorFields() {
    if (!DOM.additionalFields) return;
    
    const retiradores = AppState.users.filter(u => u.Role === ROLES.RETIRADOR && u.Status === 'Ativo');
    
    if (retiradores.length > 0) {
        const options = retiradores.map(u => `<option value="${u.UserID}">${u.Nome}</option>`).join('');
        
        DOM.additionalFields.innerHTML = `
            <div class="form-group">
                <label class="form-label">Responsável pela Retirada</label>
                <select id="retirador-select" class="form-select" required>
                    <option value="">Selecione um responsável</option>
                    ${options}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Área de Destino</label>
                <input type="text" id="area-destino" class="form-input" 
                       placeholder="Ex: Almoxarifado, Laboratório A, Sala 101..." required>
            </div>
        `;
    } else {
        google.script.run
            .withSuccessHandler(users => {
                const retiradores = users.filter(u => u.Role === ROLES.RETIRADOR && u.Status === 'Ativo');
                const options = retiradores.map(u => `<option value="${u.UserID}">${u.Nome}</option>`).join('');
                
                DOM.additionalFields.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Responsável pela Retirada</label>
                        <select id="retirador-select" class="form-select" required>
                            <option value="">Selecione um responsável</option>
                            ${options}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Área de Destino</label>
                        <input type="text" id="area-destino" class="form-input" 
                               placeholder="Ex: Almoxarifado, Laboratório A, Sala 101..." required>
                    </div>
                `;
            })
            .withFailureHandler(() => {
                DOM.additionalFields.innerHTML = '<p class="text-red-500">Erro ao carregar usuários retiradores.</p>';
            })
            .getAllUsers();
    }
}

function handleStatusUpdate(event) {
    event.preventDefault();
    
    if (!DOM.statusPedidoId || !DOM.statusSelect || !DOM.statusObservacoes) return;
    
    const pedidoId = DOM.statusPedidoId.value;
    const novoStatus = DOM.statusSelect.value;
    const observacoes = DOM.statusObservacoes.value;
    
    if (!novoStatus) {
        showNotification('Por favor, selecione um status.', 'warning');
        return;
    }
    
    let additionalData = {};

    if (novoStatus === 'Recebido') {
        additionalData = collectReceiveData();
    } else if (novoStatus === 'Retirado' || novoStatus === 'Finalizado') {
        if (!validateRetireData()) return;
        additionalData = collectRetireData();
    } else if (novoStatus === 'Aguardando Retirada') {
        if (!validateRetiradorData()) return;
        additionalData = collectRetiradorData();
    }
    
    showLoader(true, 'Atualizando status...');
    
    google.script.run
        .withSuccessHandler(handleStatusUpdateResponse)
        .withFailureHandler(handleError)
        .updatePedidoStatus(pedidoId, novoStatus, observacoes, additionalData);
}

function collectReceiveData() {
    const order = AppState.currentPedidoDetails || AppState.pedidos.find(p => p.PedidoID === DOM.statusPedidoId?.value);
    const data = {
        'NF_URL': document.getElementById('nf-url')?.value || '',
        'Boleto_URL': document.getElementById('boleto-url')?.value || ''
    };
    
    if (order && order.Itens) {
        order.Itens.forEach(item => {
            const qtdInput = document.querySelector(`[name="qtd_recebida_${item.ItemID}"]`);
            const divInput = document.querySelector(`[name="divergencias_${item.ItemID}"]`);
            
            if (qtdInput && typeof google !== 'undefined' && google.script) {
                google.script.run
                    .withSuccessHandler(() => {})
                    .withFailureHandler(handleError)
                    .updateItemRecebimento(item.ItemID, qtdInput.value, '', divInput?.value || '');
            }
        });
    }
    
    return data;
}

function validateRetireData() {
    const confirmItems = document.getElementById('confirm-items');
    const confirmDelivery = document.getElementById('confirm-delivery');
    
    if (!confirmItems?.checked || !confirmDelivery?.checked) {
        showNotification('Por favor, confirme todos os itens obrigatórios.', 'warning');
        return false;
    }
    
    return true;
}

function collectRetireData() {
    return {
        'ObservacoesRetirada': document.getElementById('retirada-divergencias')?.value || ''
    };
}

function validateRetiradorData() {
    const retirador = document.getElementById('retirador-select')?.value;
    const area = document.getElementById('area-destino')?.value;
    
    if (!retirador || !area) {
        showNotification('Por favor, preencha todos os campos obrigatórios.', 'warning');
        return false;
    }
    
    return true;
}

function collectRetiradorData() {
    return {
        'RetiradoPorID': document.getElementById('retirador-select')?.value,
        'AreaDestino': document.getElementById('area-destino')?.value
    };
}

function handleStatusUpdateResponse(success) {
    showLoader(false);
    
    if (success) {
        DOM.statusModal?.classList.add('hidden');
        showNotification('Status atualizado com sucesso!', 'success');
        
        const activeSection = document.querySelector('.nav-link.active');
        if (activeSection) {
            activeSection.click();
        }
    } else {
        showNotification('Erro ao atualizar status.', 'error');
    }
}

// ===== USER MANAGEMENT =====
function handleRegisterUser(event) {
    event.preventDefault();
    
    if (!DOM.registerName || !DOM.registerEmail || !DOM.registerPassword || !DOM.registerRole) return;
    
    const name = DOM.registerName.value.trim();
    const email = DOM.registerEmail.value.trim();
    const password = DOM.registerPassword.value.trim();
    const role = DOM.registerRole.value;
    
    if (!name || !email || !password || !role) {
        showNotification('Por favor, preencha todos os campos.', 'warning');
        return;
    }
    
    showLoader(true, 'Cadastrando usuário...');
    
    google.script.run
        .withSuccessHandler(handleRegisterResponse)
        .withFailureHandler(handleError)
        .registerUser(name, email, password, role);
}

function handleRegisterResponse(response) {
    showLoader(false);
    
    if (response && response.success) {
        DOM.registerModal?.classList.add('hidden');
        DOM.registerForm?.reset();
                showNotification('Usuário cadastrado com sucesso!', 'success');
        
        if (!DOM.usersModal?.classList.contains('hidden')) {
            loadUsers();
        }
    } else {
        showNotification(response?.message || 'Erro ao cadastrar usuário', 'error');
    }
}

function loadUsers() {
    showLoader(true, 'Carregando usuários...');
    
    google.script.run
        .withSuccessHandler(renderUsers)
        .withFailureHandler(handleError)
        .getAllUsers();
}

function renderUsers(users) {
    showLoader(false);
    
    if (!DOM.usersTableBody) return;
    
    if (!users || users.length === 0) {
        DOM.usersTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum usuário encontrado</td></tr>';
        return;
    }
    
    AppState.users = users;
    
    DOM.usersTableBody.innerHTML = users.map(user => `
        <tr>
            <td class="font-medium">${user.Nome}</td>
            <td>${user.Email}</td>
            <td>${getRoleDisplayName(user.Role)}</td>
            <td>
                <span class="badge ${user.Status === 'Ativo' ? 'badge-received' : 'badge-cancelled'}">
                    ${user.Status}
                </span>
            </td>
            <td>${formatDate(user.LastLogin)}</td>
            <td>
                <div class="flex gap-2">
                    <select class="form-select text-xs" onchange="updateUserRole('${user.UserID}', this.value)">
                        <option value="${user.Role}">${getRoleDisplayName(user.Role)}</option>
                        ${Object.values(ROLES).filter(r => r !== user.Role).map(role => 
                            `<option value="${role}">${getRoleDisplayName(role)}</option>`
                        ).join('')}
                    </select>
                    <button class="btn btn-sm ${user.Status === 'Ativo' ? 'btn-warning' : 'btn-success'}" 
                            onclick="toggleUserStatus('${user.UserID}')">
                        ${user.Status === 'Ativo' ? 'Desativar' : 'Ativar'}
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function updateUserRole(userId, newRole) {
    if (!newRole) return;
    
    showLoader(true, 'Atualizando função...');
    
    google.script.run
        .withSuccessHandler(response => {
            showLoader(false);
            if (response && response.success) {
                showNotification('Função atualizada com sucesso!', 'success');
                loadUsers();
            } else {
                showNotification(response?.message || 'Erro ao atualizar função', 'error');
            }
        })
        .withFailureHandler(handleError)
        .updateUserRole(userId, newRole);
}

function toggleUserStatus(userId) {
    showLoader(true, 'Atualizando status...');
    
    google.script.run
        .withSuccessHandler(response => {
            showLoader(false);
            if (response && response.success) {
                showNotification(`Usuário ${response.newStatus?.toLowerCase() || 'atualizado'} com sucesso!`, 'success');
                loadUsers();
            } else {
                showNotification(response?.message || 'Erro ao atualizar status', 'error');
            }
        })
        .withFailureHandler(handleError)
        .toggleUserStatus(userId);
}

// ===== NOTIFICATIONS =====
function loadNotifications() {
    if (typeof google !== 'undefined' && google.script && AppState.user) {
        google.script.run
            .withSuccessHandler(handleNotifications)
            .withFailureHandler(() => {})
            .getNotifications(AppState.user.userId);
    }
}

function handleNotifications(notifications) {
    AppState.notifications = notifications || [];
    const unreadCount = notifications ? notifications.filter(n => !n.Lida).length : 0;
    
    if (DOM.notificationCount) {
        if (unreadCount > 0) {
            DOM.notificationCount.textContent = unreadCount;
            DOM.notificationCount.classList.remove('hidden');
        } else {
            DOM.notificationCount.classList.add('hidden');
        }
    }
}

function toggleNotifications() {
    const unreadNotifications = AppState.notifications.filter(n => !n.Lida);
    
    if (unreadNotifications.length > 0) {
        const messages = unreadNotifications.slice(0, 3).map(n => n.Mensagem).join('\n');
        alert(`Notificações:\n\n${messages}`);
        
        unreadNotifications.forEach(n => {
            if (typeof google !== 'undefined' && google.script) {
                google.script.run.markNotificationAsRead(n.NotifID);
            }
        });
        
        loadNotifications();
    } else {
        showNotification('Nenhuma notificação nova.', 'info');
    }
}

// ===== REPORTS =====
function renderReportStatusChart(statusData) {
    if (!DOM.reportStatusChartCanvas || !statusData) return;
    
    const ctx = DOM.reportStatusChartCanvas.getContext('2d');
    
    if (AppState.charts.reportStatusChart) {
        AppState.charts.reportStatusChart.destroy();
    }
    
    const labels = Object.keys(statusData);
    const data = Object.values(statusData);
    
    AppState.charts.reportStatusChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Quantidade de Pedidos',
                data: data,
                backgroundColor: ['#F59E0B', '#3B82F6', '#10B981', '#8B5CF6', '#6B7280', '#EF4444'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function renderSupplierReport(supplierData) {
    if (!DOM.supplierReportTableBody) return;
    
    if (!supplierData || Object.keys(supplierData).length === 0) {
        DOM.supplierReportTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum dado encontrado</td></tr>';
        return;
    }
    
    DOM.supplierReportTableBody.innerHTML = Object.entries(supplierData).map(([fornecedor, data]) => `
        <tr>
            <td class="font-medium">${fornecedor}</td>
            <td>${data.totalPedidos}</td>
            <td class="font-medium">${formatCurrency(data.valorTotal)}</td>
            <td>${data.pedidosFinalizados}</td>
        </tr>
    `).join('');
}

function renderPerformanceReport(performanceData) {
    if (!performanceData) return;
    
    if (DOM.avgReceiveTime) {
        DOM.avgReceiveTime.textContent = performanceData.tempoMedioRecebimento 
            ? `${performanceData.tempoMedioRecebimento.toFixed(1)}` 
            : 'N/A';
    }
    
    if (DOM.avgRetiradaTime) {
        DOM.avgRetiradaTime.textContent = performanceData.tempoMedioRetirada 
            ? `${performanceData.tempoMedioRetirada.toFixed(1)}` 
            : 'N/A';
    }
    
    if (DOM.onTimeOrders) {
        DOM.onTimeOrders.textContent = performanceData.pedidosNoPrazo || 0;
    }
    
    if (DOM.lateOrders) {
        DOM.lateOrders.textContent = performanceData.pedidosAtrasados || 0;
    }
}

function renderLogs(logs) {
    if (!DOM.logsTableBody) return;
    
    if (!logs || logs.length === 0) {
        DOM.logsTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum log encontrado</td></tr>';
        return;
    }
    
    DOM.logsTableBody.innerHTML = logs.slice(0, 10).map(log => `
        <tr>
            <td>${formatDate(log.Timestamp)}</td>
            <td>${log.UserName || 'Sistema'}</td>
            <td><span class="badge badge-info">${log.Acao}</span></td>
            <td>${log.Detalhes}</td>
        </tr>
    `).join('');
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('📱 DOM carregado, inicializando aplicação...');
    
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
    
    setupLoginButtonListener();
    initializeApp();
    
    setInterval(() => {
        if (AppState.user) {
            loadNotifications();
        }
    }, 60000);
});

// ===== GLOBAL FUNCTIONS =====
window.openOrderDetails = openOrderDetails;
window.openStatusModal = openStatusModal;
window.updateUserRole = updateUserRole;
window.toggleUserStatus = toggleUserStatus;
window.handleLogin = handleLogin;
window.searchPedidos = searchPedidos;

// ===== ERROR HANDLING =====
window.onerror = function(message, source, lineno, colno, error) {
    console.error('[GLOBAL ERROR]', message, 'at', source + ':' + lineno + ':' + colno, error);
    showNotification('Erro inesperado: ' + message, 'error');
    return false;
};

// ===== DEBUGGING =====
function testPing() {
    if (typeof google !== 'undefined' && google.script) {
        google.script.run
            .withSuccessHandler(function(r){ 
                console.log('✅ Ping OK:', r);
                showNotification('Ping: ' + JSON.stringify(r), 'success'); 
            })
            .withFailureHandler(function(e){ 
                console.error('❌ Ping ERROR:', e);
                showNotification('Erro Ping: ' + e, 'error'); 
            })
            .ping();
    } else {
        showNotification('Google Apps Script não disponível', 'error');
    }
}

window.testPing = testPing;
window.AppState = AppState;
window.DOM = DOM;

console.log('🚀 Script carregado com sucesso!');
console.log('🔧 Função handleLogin disponível:', typeof window.handleLogin);
</script>


</body>
</html>